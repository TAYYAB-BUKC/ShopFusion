@page "/product/price/{Id:int}"

@inject IProductRepository _productRepository
@inject IProductPriceRepository _productPriceRepository

<h3 class="text-primary">Manage Product Prices</h3>

@if (IsLoading)
{
    <div class="text-center">
        <img src="images/loading.gif" />
    </div>
}
else
{
    <div class="row border p-2 mb-4">

        <div class="col-md-10">
            <div class="card-body">
                <h4 class="card-title mb-3 ml-3">@product.Name</h4>
                <span>
                    Category: @product.Category.Name
                </span>
                <br />
                <span>
                    Description: @((MarkupString)product.Description)
                </span>
                <br />

                <RadzenDataGrid @ref="pricesGrid" TItem="ProductPricesDTO" Data="@productPrices" AllowPaging="true">
                    <HeaderTemplate>
                        <RadzenButton ButtonStyle="ButtonStyle.Success" Icon="add_circle" Text="Add New" Click="@InsertRow" />
                        <RadzenButton ButtonStyle="ButtonStyle.Primary" Icon="edit" Text="Update" />
                        <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Text="Delete" />
                        <RadzenButton ButtonStyle="ButtonStyle.Light" Icon="close" Text="Cancel" />
                    </HeaderTemplate>
                    <Columns>
                        <RadzenDataGridColumn Property="@nameof(ProductPricesDTO.Id)" Filterable="false" Title="ID" Frozen="true" Width="80px" TextAlign="TextAlign.Center" />
                        <RadzenDataGridColumn Property="@nameof(ProductPricesDTO.Size)" Title="Size" Frozen="true" Width="160px">
                            <EditTemplate>
                                <RadzenDropDown @bind-Value="((context as ProductPricesDTO).Size)" Data="@productSizes" Style="width:100%; display: block;" InputAttributes="@(new Dictionary<string,object>(){ { "aria-label", "Select Size" }})" />
                            </EditTemplate>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="@nameof(ProductPricesDTO.Price)" Title="Price" Width="160px">
                            <EditTemplate>
                                <RadzenNumeric @bind-Value="((context as ProductPricesDTO).Price)" Style="width:100%" InputAttributes="@(new Dictionary<string,object>(){ { "aria-label", "Select freight" }})" />
                                <RadzenRequiredValidator Text="Price is required" Component="ShipName" Popup="true" />
                            </EditTemplate>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Context="order" Filterable="false" Sortable="false" TextAlign="TextAlign.Right" Frozen="true" FrozenPosition="FrozenColumnPosition.Right">
                            <EditTemplate Context="order">
                                <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Success" Variant="Variant.Flat" Size="ButtonSize.Medium" aria-label="Save">
                                </RadzenButton>
                                <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" aria-label="Cancel">
                                </RadzenButton>
                                <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Variant="Variant.Flat" Shade="Shade.Lighter" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" aria-label="Delete">
                                </RadzenButton>
                            </EditTemplate>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>


            </div>

        </div>
        <div class="col-md-2">
            <div class="text-center">
                <img src="@product.ImageURL" class="w-100" />
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private RadzenDataGrid<ProductPricesDTO> pricesGrid;
    public ProductDTO product = new();
    public IList<ProductPricesDTO> productPrices = new List<ProductPricesDTO>();
    private bool IsLoading { get; set; } = true;
    public IEnumerable<string> productSizes = new List<string>()
    {
        "Small", "Medium", "Large", "8oz", "16oz", "24oz", "32oz"
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadProductInformation();
        }
    }

    private async Task LoadProductInformation()
    {
        IsLoading = true;
        StateHasChanged();
        product = await _productRepository.GetById(Id);
        productPrices = await _productPriceRepository.GetAll(Id);
        IsLoading = false;
        StateHasChanged();
    }

    async Task InsertRow()
    {
        if (!pricesGrid.IsValid) return;

        var productPrice = new ProductPricesDTO();
        await pricesGrid.InsertRow(productPrice);
    }
}
